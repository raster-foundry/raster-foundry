#!/bin/bash
set -e

if [[ -n "${RF_DEBUG}" ]]; then
    set -x
fi

GIT_COMMIT="${GIT_COMMIT:-latest}"

function usage() {
    echo -n \
"Usage: $(basename "$0")
Fire gatling at a running backsplash server
"
}

if [ "${BASH_SOURCE[0]}" = "${0}" ]
then
    if [ "${1:-}" = "--help" ]
    then
        usage
    else
        echo "Firing gatling at staging..."
        docker-compose -f docker-compose.test.yml run gatling-sbt gatling:test || true

        reportDir=$(find ./gatling/target/gatling/ -maxdepth 1 -type d | tail -n 1)
        RESULTS_S3_URI="s3://${RESULTS_BUCKET}/gatling/${BUILD_NUMBER}/"

        echo "SYNCING RESULTS TO S3 ${reportDir} => ${RESULTS_S3_URI}"
        aws s3 sync "${reportDir}" "${RESULTS_S3_URI}"
        RESULTS_URL="https://s3.amazonaws.com/rasterfoundry-staging-it-us-east-1/gatling/${BUILD_NUMBER}/index.html"
        echo "VIEW RESULTS AT: ${RESULTS_URL}"
        curl -X POST --data-urlencode "payload={\"channel\": \"#raster-foundry\", \"username\": \"Your Friendly Neighborhood Raster Parrot\", \"text\": \"Finished load testing for build ${BUILD_NUMBER}. Results are available <${RESULTS_URL}|here>.\", \"icon_emoji\": \":raster_parrot:\"}" "${SLACK_URL}"
    fi
    exit
fi
